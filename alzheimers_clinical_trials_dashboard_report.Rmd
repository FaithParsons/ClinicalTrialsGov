---
title: "Exploration and visualization of Alzheimer's Disease clinical trials summary made easy with ACT (Alzheimer's Clinical Trials) Shiny Dashboard" 
author: "Feben Asefaha, Imaani Easthausen, Faith Parsons, Volha Tryputsen"
date: "December 4, 2017"
output: 
  html_document:
    theme: cosmo
    highlight: haddock
    toc: true
    toc_float:
      collapse: true
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(fig.width = 6, fig.asp = .6, out.width = "90%")
options(knitr.table.format = "html") 
```

```{r libraries, echo=FALSE}
library(tidyverse)
library(dplyr)
library(janitor)
library(plotly)
library(stringr)
library(plotly)
library(googleVis)
library(readr)
library(timevis)
library(XML)
library(ggmap)
library(leaflet)
library(splitstackshape)
library(purrr)
library(DT)
```

```{r options}
op <- options(gvis.plot.tag='chart')
source("functions.R")
```


# Introduction 
Alzheimers Disease (AD) is a progressive disease that destroys memory and other important mental functions. It is the [6th leading cause of death in the US](https://www.alz.org/facts/), and it [does not have a cure](https://www.alz.org/alzheimers_disease_treatments.asp). The latter fact strongly affects a family of a newly diagnosed with AD patient. Exploring the landscape of ongoing clinical trials, targeting AD, is the next step family takes to assess possible treatment options. [Clinicaltrials.gov](https://clinicaltrials.gov) is a database of clinical studies conducted around the world and is a great place to start exploring experimental treatment possibilities. It has user friendly interface and provides extensive amount of clinical trials information. However, it could be overwhelming for someone without special training to dive through tabulated extensive information available at [clinicaltrials.gov](https://clinicaltrials.gov). 
A web-based visualization tool, which summaries Alzheimer`s Disease clinal trial information while sourcing data from [clinicaltrials.gov](https://clinicaltrials.gov), could be a useful tool for those families, impacted by the illness and seeking a quick visual reference guide on Alzheimers Disease clinical trials past and present research.  


# Data and methods   



## File names [Imaani]  

[### Loading data]  

[### Reorganizing into usable form]   

[### Any general-preprocessing steps?]    


## Summary statistics [Faith/Volha?]  

```{r load_data}
data = 
  read_csv("Data/SearchResultsTable.csv") %>%
  clean_names() 
```

[Mean, sample size etc.]  



## Exploratory analysis [Volha will combine three figures]  


```{r data_preprocessing_figure1}
gantt_data = 
  data %>%
  mutate( 
    mm_start   = str_sub(start_date,  1,  3), # Extract month
    yy_start   = str_sub(start_date, -4, -1), # Extract 4-digit year
    date_start = as.Date(paste(yy_start, mm_start, "01", sep = "-"), "%Y-%b-%d"),
    mm_end     = str_sub(completion_date,  1,  3),
    yy_end     = str_sub(completion_date, -4, -1),
    date_end   = as.Date(paste(yy_end,   mm_end,   "01", sep = "-"), "%Y-%b-%d"),
    n_locations = str_count(locations , "\\|"),
    n_treatments = str_count(interventions, "\\|"),
    label = ifelse(acronym == "null", title, acronym)
    ) %>%
  select(nct_number, title, acronym, date_start, date_end, n_locations, n_treatments,
           phases, study_type, label, recruitment) %>%
  # Exclude records with no start or end dates
  filter(!is.na(date_start) & !is.na(date_end))%>% 
  select(label, everything()) %>%
  # Declare interactivity filters here
  filter(study_type == "Interventional"  & str_detect(phases, "Phase 3") &  recruitment == "Recruiting") %>%
  #Sort by date
  arrange(date_start)
```


```{r data_preprocessing_figure2}
data_for_plot = 
  data %>% 
  select(rank, nct_number, phases, study_type, enrollment, nct_number, age, recruitment) %>% 
  mutate(age_start   = str_sub(age,  1,  3) ) %>%
  mutate(age_start = replace(age_start, age_start == "Chi", 0)) %>%
  mutate(age_start = replace(age_start, age_start == "up ", 0)) %>%
  separate(age_start, c("age_start", "remove"), " ") %>%
  mutate(age_start = as.numeric(age_start)) %>%
  mutate(n = as.numeric(enrollment)) %>%
    mutate(age_end = str_sub(age, 13, 14)) %>%
  # replace "...Years and older   (Adult, Senior)" with age_end==100
  mutate(age_end = replace(age_end, age_end == " o", 100)) %>%
  #replace "Child, Adult, Senior" with age_end == 100
  mutate(age_end = replace(age_end, age_end == ", ", 100)) %>%
  #replace "up to 100 Years   (Child, Adult, Senior)" with age_end==100
  mutate(age_end = replace(age_end, age_end == "ar", 100)) %>%
  # replace "...Years and older   (Child, Adult, Senior)" for those with 
  # starting one digit age with age_end == 100
  mutate(age_end = replace(age_end, age_end == "ol", 100)) %>%
  # replace "up to ..Years   (Child, Adult, Senior)" where ... is 2 digit
  # with age_end == 100
  mutate(age_end1 = str_sub(age, 7, 8)) %>%
  mutate(age_end = replace(age_end, age_end == "rs", age_end1[age_end == "rs"])) %>%
  # convert age_end to numeric
  mutate(age_end = as.numeric(age_end)) %>%
  select(-c(remove, age_end1)) %>%
  # reorder 
  mutate(nct_number = forcats::fct_reorder(nct_number, age_start))


# Prepare data for line plot - convert into long format and group by nct_number:   


data_for_line_plot = 
  data_for_plot %>%
  filter(study_type == "Interventional"  & str_detect(phases, "Phase 3") &  recruitment == "Recruiting") %>%
  gather(key = "eligible_age", value = "years", age_start, age_end) %>%
  group_by(nct_number) %>%
  arrange(years)
```


```{r data_preprocessing_figure3}
AD_search_results =
  data %>% 
  dplyr::select(nct_number, recruitment, interventions, gender, age,
         phases, enrollment, study_type, locations) %>% 
  filter(str_detect(locations, "United States")) %>%
  separate(phases, into = c("phase_a", "phase_b", "phase_c", "phase_d"), sep = "\\|")  

## separate multiple locations into individual columns
AD_search_results_split_locations = 
  AD_search_results %>%
  cSplit("locations", sep = '|')

for (i in 12:dim(AD_search_results_split_locations)[2]) {
  AD_search_results_split_locations[[i]] = map(AD_search_results_split_locations[[i]], clean_loc)
}



## gathering locations and phases
AD_edit <- AD_search_results_split_locations %>% 
  gather( key = place, value = location, locations_001:locations_348) %>% 
  select(-place) %>% 
  gather( key = remove, value = phase, phase_a:phase_d) %>% 
  select(-remove)

## simplifying interventions, removing additional country indicator 
## city and state columns
AD_edit_unique <- AD_edit %>% 
  separate(interventions, into = c("interventions", "remove"), sep = ':') %>% 
  select(-remove) %>%
  mutate(location = sub("(.+), United States", "\\1", location)) %>% 
  separate(location, into = c("city", "state"), sep = ", ") %>% 
  unique() 
  

##Data set from this set is AD_edit_unique

AD_new <- AD_edit_unique %>% 
  mutate(age = sub("^([^()]+)$", "(\\1)", age)) %>% 
  mutate(cleaned_age = str_extract(age, "\\(.+\\)")) %>%
  mutate(cleaned_age = sub("\\((.+)\\)", "\\1", cleaned_age)) %>% 
   select(-age, -enrollment) 

state_list <- list()
state_list[['name']] = c(state.name,"District of Columbia")
state_list[['abb']] = c(state.abb,"DC")

state_lookup <- setNames(state_list$abb, state_list$name)

##filter out any entry without state because can't map it  
AD_newer <- AD_new %>% 
  rename(state_name = state) %>%
  filter(!is.na(state_name)) %>%
  mutate(state_code = state_lookup[state_name])


## merging city and state code

AD_newer$geo_place <- paste(AD_newer$city, ",", AD_newer$state_code)

## finding all empty cells and replace each one with a string

AD_newer[is.na(AD_newer)] <- "Not available"

```



## Formal analysis [Faith?]  



# Results [Volha and all]  

Figure 1:  Gantt chart  
```{r figure1, results='asis', tidy=FALSE, eval = FALSE}
timeline = 
  gvisTimeline(data = gantt_data,
               rowlabel = "nct_number",
               barlabel = "label",
               start = "date_start",
               end = "date_end",
               options = list(height = 600, width = 800, 
                             timeline = "{ singleColor: 'blue' }"))
plot(timeline)
```


Figure 2: Interactive plot with lines for eligible age for different clinical trail phases    
```{r}
p = data_for_line_plot %>%
  na.omit() %>% 
  ggplot(aes(x = years, y = n, color = nct_number, group = nct_number)) +
  geom_path() +
  #facet_wrap(~study_type) +
  labs(x = "eligible age",
       y = "enrollment",
       caption = "Figure 2") +
  theme_bw()

ggplotly(p)
```

Figure 3:  
```{r figure3}

```


```{r interactive_data_table}
DT::datatable(data, class = 'compact',
              rownames = FALSE,
              caption = 'Table 1')
```


```{r}
options(op)
```



Shiny dashboard simplifies Alzheimers Disease landscape research for an inexperienced user and as such provides benefit for a family of a newly diagnosed Alzheimers Disease patient.  




# Discussion  


