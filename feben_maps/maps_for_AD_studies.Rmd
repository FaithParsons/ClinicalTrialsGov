---
title: "Map visualization for AD studies"
author: "Feben Asefaha"
date: "12/1/2017"
output: html_document
---

```{r setup, include=FALSE}
#loading packages
library(tidyverse)
library(dplyr)
library(janitor)
library(haven)
library(stringr)
library(knitr)
library(plotly)
library(ggplot2)
library(viridis)
library(flexdashboard)
library(readr)
library(readxl)
library(ggmap)
library(leaflet)
library(splitstackshape)
library(purrr)

knitr::opts_chunk$set(echo = TRUE)
```


The variables I am interested in utilizing are 

PHASE
ID 
AGE
GENDER
RECRUITMENT STAGE
INTERVENTIONS
LOCATION

From LOCATION, cleaning to derive CITY, STATE

Using ggmap function geocode(), get the lat and long for each city using the Google Maps Geocoding API.


(this is accessing the web, so you can't send too many at once! Otherwise you will get back as NAs. So I will make filtering by state a requirement)

Plot those coordinates using leaflet package

(See below)


Leaflet is supposed to work well with Shiny...

So intend to add drop down menus:

STATE(necessary; if you get an NA, reload and it should be fine)
RECRUITMENT(Recruiting, Completed, By invitation only, etc)
PHASE (1, 2, 1 and 2)
INTERVENTION (Behavioral, Genetic, Device, Drug, Other)
AGE (categorized into groups)
GENDER (Female, Male, All)

```{r order of stuff}

## Download data
## for location, have to locate strings that end in "United States"
## Every time you see a usable address, it's "City, State, Country"
## I have to isolate "City, State, Country" and then separate the three
## mutate a column that gets the state abbrev for each State
## merge each state abbrev with the city in a new column, with a comma separating
## geocode function from ggmap will let me get lat and long for each "City, ST"ate


## make sure lat and lng get their own columns
## from there, I can map them using leaflet
## can use leaflet to apply interactivity
## and from there, can apply Shiny interactivity with dropdown menus

```


```{r loading data}

## import data, select variables of interest, filter for US locations 
AD_search_results <- read_csv("../data/SearchResultsTable.csv") %>%  clean_names() %>% 
  select(nct_number, recruitment, interventions, gender, age,
         phases, enrollment, study_type, locations) %>% 
  filter(str_detect(locations, "United States")) %>%
  separate(phases, into = c("phase_a", "phase_b", "phase_c", "phase_d"), sep = "\\|")  
  # separate(locations, into = c(), sep = "\\|") %>% 
  

```



```{r  Part 2 FUNCTION TO GET EXTRACT LOCATIONS}

AD_search_results_split_locations <- AD_search_results %>%
  cSplit("locations", sep = '|')

## 
clean_loc = function(location) {
  
  result <- location
  
  if (grepl("United States", location, fixed = TRUE)) {
    result = sub(".*, (.+), (.+), United States(.*)", "\\1, \\2", location)
  } else {
    result  = ""
  }
  
  result
}




for (i in 12:dim(AD_search_results_split_locations)[2]) {
  AD_search_results_split_locations[[i]] = map(AD_search_results_split_locations[[i]], clean_loc)
}


```


```{r Part 3 CLEANUP}

## gathering locations and phases
AD_edit <- AD_search_results_split_locations %>% 
  gather( key = place, value = location, locations_001:locations_348) %>% 
  select(-place) %>% 
  gather( key = remove, value = phase, phase_a:phase_d) %>% 
  select(-remove)

## simplifying interventions, removing additional country indicator 
## city and state columns
AD_edit_unique <- AD_edit %>% 
  separate(interventions, into = c("interventions", "remove"), sep = ':') %>% 
  select(-remove) %>%
  mutate(location = sub("(.+), United States", "\\1", location)) %>% 
  separate(location, into = c("city", "state"), sep = ", ") %>% 
  unique() 
  

View(AD_edit_unique)

```

```{r Part 4 AGE GROUPS variable}


## cleaning up AGE variable for drop-down menu
dim(AD_edit_unique)

AD_edit_unique %>% 
  group_by(age) %>% 
  summarize()

## Child is 0 - 17, Adult is 18 - 65, Senior is 66 +
## extracting age group labels

AD_new <- AD_edit_unique %>% 
  mutate(age = sub("^([^()]+)$", "(\\1)", age)) %>% 
  mutate(cleaned_age = str_extract(age, "\\(.+\\)")) %>%
  mutate(cleaned_age = sub("\\((.+)\\)", "\\1", cleaned_age)) %>% 
   select(-age, -enrollment) 

# View(AD_new)



AD_new %>% 
  count(cleaned_age) 


View(AD_new)
dim(AD_new)

```


```{r Part 5 SETTING UP A COLUMN FOR GEOCODE ACCESS}

## getting state abbrevs

AD_new %>% 
  count(state)

state_list <- list()
state_list[['name']] = c(state.name,"District of Columbia")
state_list[['abb']] = c(state.abb,"DC")

state_lookup <- setNames(state_list$abb, state_list$name)

##filter out any entry without state because can't map it  
AD_newer <- AD_new %>% 
  rename(state_name = state) %>%
  filter(!is.na(state_name)) %>%
  mutate(state_code = state_lookup[state_name])

AD_newer %>% 
  count(gender)



## merging city and state code

AD_newer$geo_place <- paste(AD_newer$city, ",", AD_newer$state_code)

## finding all empty cells and replace each one with a string

AD_newer[is.na(AD_newer)] <- "Not available"

View(AD_newer)
dim(AD_newer)


```

I'm not sure if I should try to have it call latitude and longitude live or write a function to get lat and long like 10 at a time and then put them in their own columns? That might be better since this is a static dataset ways. It would have to be looped to do it like ten at a time because if you request too many for the site it returns some NAs.

The way I got the maps to work before was by filtering out by state, and making that into a new dataset, and having geocode work on an entire column that was "X, Y", X being city names, and Y being the states. That's not really efficient for our code so I'd like to try the function idea. Will get back to later.

```{r Part 6 MAKING MAPS}

## getting latitude and longitude for geo_place

##example
geocode("New York , NY")

##previous example code I had used to make maps
# us_data_tristate <- us_data %>% 
#   filter(state %in% c("NEW YORK", "NEW JERSEY","CONNECTICUT"))
# 
# geocode(us_data_tristate$place) %>%
#   leaflet() %>% 
#   addTiles() %>%
#   addMarkers()



```





